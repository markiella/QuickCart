{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Quick Cart{% endblock %}</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="{% static 'img/logo.png' %}">
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Custom CSS -->
    <link href="{% static 'css/style.css' %}" rel="stylesheet">
    
    <!-- Sidebar Specific Styles (Inherited from Admin Design) -->
    <style>
    .sidebar {
        position: fixed;
        top: 0;
        left: 0;
        height: 100vh;
        width: 280px;
        background: #2c3e50;
        color: white;
        overflow-y: auto;
        z-index: 1000;
        transition: transform 0.3s ease;
    }
    
    .sidebar-collapsed {
        transform: translateX(-280px);
    }
    
    .main-content {
        margin-left: 280px;
        min-height: 100vh;
        transition: margin-left 0.3s ease;
    }
    
    .main-content.expanded {
        margin-left: 0;
    }
    
    .sidebar-toggle {
        position: fixed;
        top: 15px;
        left: 15px;
        z-index: 1001;
        background: var(--qc-orange);
        border: none;
        border-radius: 8px;
        color: white;
        padding: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }
    
    .sidebar-brand {
        padding: 1.5rem;
        border-bottom: 1px solid rgba(255,255,255,0.1);
        background: rgba(0,0,0,0.3);
    }
    
    .sidebar-nav {
        padding: 1rem 0;
    }
    
    .sidebar-nav .nav-link {
        color: rgba(255,255,255,0.8);
        padding: 0.75rem 1.5rem;
        border: none;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        border-radius: 0.375rem;
        margin: 0 0.5rem;
    }
    
    .sidebar-nav .nav-link:hover {
        color: white;
        background-color: rgba(255, 255, 255, 0.1) !important;
        border-radius: 0.375rem;
        margin: 0 0.5rem;
    }
    
    .sidebar-nav .nav-link.active {
        color: white;
        background-color: rgba(255, 255, 255, 0.1) !important;
        border-radius: 0.375rem;
        margin: 0 0.5rem;
    }
    
    .sidebar-nav .nav-link i {
        width: 20px;
        margin-right: 0.75rem;
    }
    
    .sidebar-footer {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        padding: 1rem;
        border-top: 1px solid rgba(255,255,255,0.1);
        background: rgba(0,0,0,0.3);
    }
    
    .user-info {
        display: flex;
        align-items: center;
        margin-bottom: 1rem;
    }
    
    .user-avatar {
        width: 40px;
        height: 40px;
        background: linear-gradient(135deg, var(--qc-orange) 0%, var(--qc-blue) 100%);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 0.75rem;
    }
    
    .dropdown-menu-dark {
        background-color: #343a40;
        border: 1px solid #495057;
    }
    
    /* Mobile Responsive */
    @media (max-width: 991.98px) {
        .sidebar {
            transform: translateX(-280px);
        }
        
        .sidebar.show {
            transform: translateX(0);
        }
        
        .main-content {
            margin-left: 0;
        }
        
        .sidebar-toggle {
            display: block;
        }
    }
    
    @media (min-width: 992px) {
        .sidebar-toggle {
            display: none;
        }
    }
    
    /* Category dropdown in sidebar */
    .sidebar .dropdown {
        position: relative;
    }
    
    .sidebar-dropdown {
        background: rgba(0,0,0,0.5);
        border-radius: 8px;
        border: 1px solid rgba(255,255,255,0.15);
        margin: 0.5rem 1rem;
        min-width: auto;
        box-shadow: 0 8px 16px rgba(0,0,0,0.3);
        position: static;
        z-index: 1050;
        max-height: 300px;
        overflow-y: auto;
        display: none;
    }
    
    .sidebar-dropdown.show {
        display: block;
    }
    
    .sidebar-dropdown .dropdown-item {
        color: rgba(255,255,255,0.85);
        padding: 0.65rem 1.25rem;
        font-size: 0.9rem;
        border-bottom: 1px solid rgba(255,255,255,0.08);
        transition: all 0.2s ease;
    }
    
    .sidebar-dropdown .dropdown-item:first-child {
        border-radius: 6px 6px 0 0;
    }
    
    .sidebar-dropdown .dropdown-item:last-child {
        border-bottom: none;
        border-radius: 0 0 6px 6px;
    }
    
    .sidebar-dropdown .dropdown-item:hover {
        background: rgba(241, 90, 36, 0.3);
        color: white;
        padding-left: 1.5rem;
    }
    
    .sidebar .dropdown-toggle::after {
        margin-left: auto;
        transition: transform 0.2s ease;
    }
    
    .sidebar .dropdown-toggle[aria-expanded="true"]::after {
        transform: rotate(180deg);
    }
    </style>
    
    {% block extra_css %}{% endblock %}
</head>
<body class="bg-light">
    <!-- Mobile Sidebar Toggle -->
    <button class="sidebar-toggle d-lg-none" type="button" onclick="toggleSidebar()">
        <i class="bi bi-list"></i>
    </button>

    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <!-- Sidebar Brand -->
        <div class="sidebar-brand">
            <div class="d-flex align-items-center mb-2">
                <img src="{% static 'img/logo.png' %}" alt="Quick Cart Logo" style="height: 40px; width: auto; margin-right: 0.75rem;">
                <div>
                    <h5 class="mb-0">
                        {% if user.is_authenticated and user.role == 'rider' %}
                        Rider Panel
                        {% else %}
                        Quick Cart
                        {% endif %}
                    </h5>
                </div>
            </div>
            <small class="text-muted">
                {% if user.is_authenticated and user.role == 'rider' %}
                Delivery Management
                {% else %}
                Your Online Grocery Store
                {% endif %}
            </small>
        </div>
        
        <!-- Sidebar Navigation -->
        <nav class="sidebar-nav">
            <!-- Home - Hide for riders -->
            {% if not user.is_authenticated or user.role != 'rider' %}
            <a class="nav-link {% if request.resolver_match.url_name == 'product_list' %}active{% endif %}" 
               href="{% url 'store:product_list' %}">
                <i class="bi bi-house"></i>
                Home
            </a>
            {% endif %}
            
            <!-- Categories Dropdown - Hide for riders -->
            {% if not user.is_authenticated or user.role != 'rider' %}
            <div class="dropdown">
                <a class="nav-link dropdown-toggle" href="#" data-bs-toggle="dropdown">
                    <i class="bi bi-grid"></i>
                    Categories
                </a>
                <ul class="dropdown-menu sidebar-dropdown w-100">
                    {% for category in categories %}
                    <li><a class="dropdown-item" href="{% url 'store:category_products' category.slug %}">
                        {{ category.name }}
                    </a></li>
                    {% empty %}
                    <li><span class="dropdown-item text-muted">No categories available</span></li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}
            
            {% if user.is_authenticated %}
                <!-- My Cart - Hide for admin and rider -->
                {% if user.role != 'admin' and user.role != 'rider' %}
                <a class="nav-link {% if 'cart' in request.resolver_match.url_name %}active{% endif %}" 
                   href="{% url 'cart:cart_detail' %}">
                    <i class="bi bi-cart3"></i>
                    My Cart
                    {% if cart_total_items > 0 %}
                    <span class="badge bg-danger ms-auto">{{ cart_total_items }}</span>
                    {% endif %}
                </a>
                {% endif %}
                
                {% if user.role == 'customer' %}
                <a class="nav-link {% if 'order' in request.resolver_match.url_name %}active{% endif %}" 
                   href="{% url 'orders:order_list' %}">
                    <i class="bi bi-bag"></i>
                    My Orders
                </a>
                {% elif user.role == 'rider' %}
                <a class="nav-link {% if 'staff_order' in request.resolver_match.url_name or 'order' in request.resolver_match.url_name %}active{% endif %}" 
                   href="{% url 'orders:staff_order_list' %}">
                    <i class="bi bi-truck"></i>
                    My Deliveries
                </a>
                {% endif %}
                
                {% if user.role == 'admin' or user.role == 'rider' %}
                <a class="nav-link {% if 'dashboard' in request.resolver_match.url_name %}active{% endif %}" 
                   href="{% url 'dashboard:home' %}">
                    <i class="bi bi-speedometer2"></i>
                    Dashboard
                </a>
                {% endif %}
                
                <a class="nav-link {% if 'profile' in request.resolver_match.url_name %}active{% endif %}" 
                   href="{% url 'accounts:profile' %}">
                    <i class="bi bi-person"></i>
                    Profile
                </a>
                
                <!-- Promotions - Hide for admin and rider -->
                {% if user.role != 'admin' and user.role != 'rider' %}
                <a class="nav-link {% if 'promo' in request.resolver_match.url_name %}active{% endif %}" 
                   href="{% url 'discounts:promo_list' %}">
                    <i class="bi bi-tag"></i>
                    Promotions
                </a>
                {% endif %}
            {% else %}
                <a class="nav-link" href="{% url 'accounts:login' %}">
                    <i class="bi bi-box-arrow-in-right"></i>
                    Login
                </a>
                <a class="nav-link" href="{% url 'accounts:register' %}">
                    <i class="bi bi-person-plus"></i>
                    Register
                </a>
            {% endif %}
        </nav>
        
        <!-- Sidebar Footer -->
        {% if user.is_authenticated %}
        <div class="sidebar-footer">
            <div class="user-info">
                <div class="user-avatar">
                    <i class="bi bi-person-fill text-white"></i>
                </div>
                <div>
                    <div class="fw-semibold">{{ user.get_full_name|default:user.username }}</div>
                    <small class="text-muted">{{ user.role|title }}</small>
                </div>
            </div>
            
            <form method="post" action="{% url 'accounts:logout' %}" class="w-100">
                {% csrf_token %}
                <button type="submit" class="btn btn-danger btn-sm w-100">
                    <i class="bi bi-box-arrow-right me-2"></i>Logout
                </button>
            </form>
        </div>
        {% endif %}
    </div>
    
    <!-- Main Content -->
    <div class="main-content" id="mainContent">
        <div class="container-fluid p-4">
            <!-- Messages -->
            {% if messages %}
            <div class="row">
                <div class="col-12">
                    {% for message in messages %}
                    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            
            {% block content %}
            {% endblock %}
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer bg-dark text-white py-5" style="margin-left: 280px;">
        <div class="container">
            <div class="row">
                <div class="col-lg-4 mb-4">
                    <h5 class="mb-3">Quick Cart</h5>
                    <p class="text-muted">Your trusted online grocery store delivering fresh products right to your doorstep.</p>
                    <div class="social-links">
                        <a href="#" class="text-muted me-3"><i class="bi bi-facebook"></i></a>
                        <a href="#" class="text-muted me-3"><i class="bi bi-twitter"></i></a>
                        <a href="#" class="text-muted me-3"><i class="bi bi-instagram"></i></a>
                        <a href="#" class="text-muted"><i class="bi bi-youtube"></i></a>
                    </div>
                </div>
                <div class="col-lg-2 col-md-6 mb-4">
                    <h6 class="mb-3">Quick Links</h6>
                    <ul class="list-unstyled">
                        <li><a href="{% url 'store:product_list' %}" class="text-muted">Products</a></li>
                        {% for category in categories|slice:":4" %}
                        <li><a href="{% url 'store:category_products' category.slug %}" class="text-muted">{{ category.name }}</a></li>
                        {% endfor %}
                    </ul>
                </div>
                <div class="col-lg-2 col-md-6 mb-4">
                    <h6 class="mb-3">Features</h6>
                    <ul class="list-unstyled">
                        <li><span class="text-muted">Fast Delivery</span></li>
                        <li><span class="text-muted">Fresh Products</span></li>
                        <li><span class="text-muted">Best Prices</span></li>
                        <li><span class="text-muted">24/7 Support</span></li>
                    </ul>
                </div>
                <div class="col-lg-4 mb-4">
                    <h6 class="mb-3">Contact Info</h6>
                    <p class="text-muted mb-2"><i class="bi bi-geo-alt me-2"></i>123 Grocery Street, City, Country</p>
                    <p class="text-muted mb-2"><i class="bi bi-telephone me-2"></i>+1 (555) 123-4567</p>
                    <p class="text-muted"><i class="bi bi-envelope me-2"></i>info@quickcart.com</p>
                </div>
            </div>
            <hr class="my-4">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <p class="mb-0 text-muted">&copy; 2024 Quick Cart. All rights reserved.</p>
                </div>
                <div class="col-md-6 text-md-end">
                    <small class="text-muted">Made with <i class="bi bi-heart-fill text-danger"></i> for fresh groceries</small>
                </div>
            </div>
        </div>
    </footer>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Custom JS -->
    <script src="{% load static %}{% static 'js/main.js' %}"></script>
    
    <!-- Sidebar Toggle Script -->
    <script>
    function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        const mainContent = document.getElementById('mainContent');
        
        sidebar.classList.toggle('show');
        
        // Close sidebar when clicking outside on mobile
        if (sidebar.classList.contains('show')) {
            document.addEventListener('click', closeSidebarOnClickOutside);
        } else {
            document.removeEventListener('click', closeSidebarOnClickOutside);
        }
    }
    
    function closeSidebarOnClickOutside(event) {
        const sidebar = document.getElementById('sidebar');
        const toggleBtn = document.querySelector('.sidebar-toggle');
        
        if (!sidebar.contains(event.target) && !toggleBtn.contains(event.target)) {
            sidebar.classList.remove('show');
            document.removeEventListener('click', closeSidebarOnClickOutside);
        }
    }
    
    // Adjust footer margin on mobile
    function adjustFooterMargin() {
        const footer = document.querySelector('.footer');
        if (window.innerWidth < 992) {
            footer.style.marginLeft = '0';
        } else {
            footer.style.marginLeft = '280px';
        }
    }
    
    window.addEventListener('resize', adjustFooterMargin);
    adjustFooterMargin();
    </script>
    
    <!-- Live Search JavaScript -->
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const searchInput = document.getElementById('liveSearchInput');
        const searchResults = document.getElementById('liveSearchResults');
        const searchResultsList = document.getElementById('searchResultsList');
        const searchLoading = document.getElementById('searchLoading');
        const noResults = document.getElementById('noResults');
        const searchIcon = document.getElementById('searchIcon');
        const searchSpinner = document.getElementById('searchSpinner');
        
        if (!searchInput) return; // Exit if no search input found
        
        let searchTimeout;
        let currentRequest;
        
        // Hide results when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.search-container')) {
                hideResults();
            }
        });
        
        // Show results when focusing on input
        searchInput.addEventListener('focus', function() {
            if (this.value.length >= 2 && searchResultsList.children.length > 0) {
                showResults();
            }
        });
        
        // Handle input changes
        searchInput.addEventListener('input', function() {
            const query = this.value.trim();
            const categorySlug = this.getAttribute('data-category') || '';
            
            // Clear previous timeout
            if (searchTimeout) {
                clearTimeout(searchTimeout);
            }
            
            // Cancel previous request
            if (currentRequest) {
                currentRequest.abort();
            }
            
            if (query.length < 2) {
                hideResults();
                return;
            }
            
            // Show loading state immediately for better UX
            showLoading();
            
            // Reduced debounce for faster response (200ms instead of 300ms)
            searchTimeout = setTimeout(() => {
                performSearch(query, categorySlug);
            }, 200);
        });
        
        // Handle keyboard navigation
        searchInput.addEventListener('keydown', function(e) {
            const results = document.querySelectorAll('.search-result-item');
            let currentIndex = -1;
            
            // Find currently selected item
            results.forEach((item, index) => {
                if (item.classList.contains('selected')) {
                    currentIndex = index;
                }
            });
            
            switch(e.key) {
                case 'ArrowDown':
                    e.preventDefault();
                    if (currentIndex < results.length - 1) {
                        if (currentIndex >= 0) {
                            results[currentIndex].classList.remove('selected');
                        }
                        results[currentIndex + 1].classList.add('selected');
                    }
                    break;
                    
                case 'ArrowUp':
                    e.preventDefault();
                    if (currentIndex > 0) {
                        results[currentIndex].classList.remove('selected');
                        results[currentIndex - 1].classList.add('selected');
                    }
                    break;
                    
                case 'Enter':
                    e.preventDefault();
                    if (currentIndex >= 0 && results[currentIndex]) {
                        results[currentIndex].click();
                    }
                    break;
                    
                case 'Escape':
                    hideResults();
                    this.blur();
                    break;
            }
        });
        
        function performSearch(query, categorySlug) {
            const url = new URL('{% url "store:live_search" %}', window.location.origin);
            url.searchParams.append('q', query);
            if (categorySlug) {
                url.searchParams.append('category', categorySlug);
            }
            
            currentRequest = fetch(url, {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                }
            })
            .then(response => response.json())
            .then(data => {
                hideLoading();
                displayResults(data.results);
            })
            .catch(error => {
                if (error.name !== 'AbortError') {
                    console.error('Search error:', error);
                    hideLoading();
                    hideResults();
                }
            });
        }
        
        function displayResults(results) {
            searchResultsList.innerHTML = '';
            
            if (results.length === 0) {
                showNoResults();
                return;
            }
            
            results.forEach(product => {
                const resultItem = createResultItem(product);
                searchResultsList.appendChild(resultItem);
            });
            
            showResults();
        }
        
        function createResultItem(product) {
            const item = document.createElement('div');
            item.className = 'search-result-item p-3 border-bottom';
            item.style.cursor = 'pointer';
            
            const stockBadge = getStockBadge(product.stock_status);
            
            item.innerHTML = `
                <div class="d-flex align-items-center">
                    <div class="product-icon me-3" style="font-size: 1.5rem;">
                        ${product.icon}
                    </div>
                    <div class="flex-grow-1">
                        <div class="fw-semibold">${product.name}</div>
                        <div class="small text-muted">${product.category}</div>
                        <div class="text-success fw-bold">â‚±${product.price} per ${product.unit}</div>
                    </div>
                    <div class="text-end">
                        ${stockBadge}
                    </div>
                </div>
            `;
            
            // Add hover effect
            item.addEventListener('mouseenter', function() {
                this.style.backgroundColor = '#f8f9fa';
            });
            
            item.addEventListener('mouseleave', function() {
                this.style.backgroundColor = '';
            });
            
            // Navigate to product on click
            item.addEventListener('click', function() {
                window.location.href = `/store/product/${product.slug}/`;
            });
            
            return item;
        }
        
        function getStockBadge(stockStatus) {
            switch(stockStatus) {
                case 'in_stock':
                    return '<span class="badge bg-success">In Stock</span>';
                case 'low_stock':
                    return '<span class="badge bg-warning">Low Stock</span>';
                case 'out_of_stock':
                    return '<span class="badge bg-danger">Out of Stock</span>';
                default:
                    return '';
            }
        }
        
        function showResults() {
            searchResults.style.display = 'block';
            noResults.style.display = 'none';
        }
        
        function hideResults() {
            searchResults.style.display = 'none';
        }
        
        function showLoading() {
            searchResults.style.display = 'block';
            searchLoading.style.display = 'block';
            searchResultsList.style.display = 'none';
            noResults.style.display = 'none';
            
            // Show spinner in input field
            if (searchIcon) searchIcon.classList.add('d-none');
            if (searchSpinner) searchSpinner.classList.remove('d-none');
        }
        
        function hideLoading() {
            searchLoading.style.display = 'none';
            searchResultsList.style.display = 'block';
            
            // Hide spinner, show search icon
            if (searchSpinner) searchSpinner.classList.add('d-none');
            if (searchIcon) searchIcon.classList.remove('d-none');
        }
        
        function showNoResults() {
            searchResults.style.display = 'block';
            noResults.style.display = 'block';
            searchResultsList.style.display = 'none';
        }
    });
    </script>

    {% block extra_js %}{% endblock %}
</body>
</html>
